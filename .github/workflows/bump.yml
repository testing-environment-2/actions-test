name: Bump semver git tag

on:
  push:

jobs:
  bump_semver_git_tag:
    runs-on: ubuntu-latest

    steps:
      - name: Set up access token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
            app-id: ${{ vars.APP_ID }}
            private-key: ${{ secrets.APP_PRIVATE_KEY }}
            owner: testing-environment-2

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ steps.app-token.outputs.token }}

      - name: Install cocogitto
        run: |
          curl -L -o cog.tar.gz https://github.com/cocogitto/cocogitto/releases/latest/download/cocogitto-5.6.0-x86_64-unknown-linux-musl.tar.gz
          tar -xzf cog.tar.gz
          sudo mv cog /usr/local/bin/

      - name: Bump version and create tag
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Configure git to use app token
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git remote set-url origin https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/tunedd/${{ github.event.repository.name }}.git

          # Get current tag
          current_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # Run cog check from latest tag
          cog check --from-latest-tag

          # Bump version
          cog bump --auto --skip-untracked --disable-bump-commit

          # Get new tag
          new_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # Push new tag if different
          if [ "$current_tag" != "$new_tag" ] && [ -n "$new_tag" ]; then
            git push origin $new_tag
          fi
